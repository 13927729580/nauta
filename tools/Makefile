GLOBAL_WORKSPACE:=$(CURDIR)/.workspace
GLOBAL_VIRTUALENV_DIR:=$(CURDIR)/.venv

DIRECTORY:=$(CURDIR)
WORKSPACE_NAME:=tools
include $(CURDIR)/makelibs/commons.mk

PLATFORM_CONFIG:=$(CURDIR)/platform-config.yml
DLS4E_CONFIG:=$(CURDIR)/dls4e-config.yml
COMPILER_CONFIG:=$(CURDIR)/compiler-config.yml

PUSH_MAKE:=(cd $(CURDIR)/push && make build)
RPMS_MAKE:=(cd $(CURDIR)/rpms-build && make build)
CHART_MAKE:=(cd $(CURDIR)/chart-composer && make build)
CONTAINER_MAKE:=(cd $(CURDIR)/container-build && make build)
FINALIZERS_PLATFORM_MAKE:=(cd $(CURDIR)/finalizers/platform && make build)
FINALIZERS_DLS4E_MAKE:=(cd $(CURDIR)/finalizers/dls4e && make build)
FINALIZERS_BIN_MAKE:=(cd $(CURDIR)/finalizers/bin && make build)
FINALIZERS_DOCS_MAKE:=(cd $(CURDIR)/finalizers/docs && make build)
FINALIZERS_RELEASE_MAKE:=(cd $(CURDIR)/finalizers/release && make build)

DOCKER_PACKAGE:=$(BUILD_DIR)/docker.tar.gz
PLATFORM_PACKAGE:=$(BUILD_DIR)/platform.tar.gz
PLATFORM_CHART:=$(BUILD_DIR)/platform-chart.tar.gz
COMPILER_PACKAGE:=$(BUILD_DIR)/compiler
DLS4E_PACKAGE:=$(BUILD_DIR)/dls4e.tar.gz
DLS4E_CHART:=$(BUILD_DIR)/dls4e-chart.tar.gz
PLATFORM_RELEASE_PACKAGE:=$(BUILD_DIR)/platform-release.tar.gz
BIN_RELEASE_PACKAGE:=$(BUILD_DIR)/bin-release.tar.gz
DLS4E_RELEASE_PACKAGE:=$(BUILD_DIR)/dls4e-release.tar.gz
DOCS_RELEASE_PACKAGE:=$(BUILD_DIR)/docs-release.tar.gz
RELEASE_PACKAGE:=$(WORKSPACE)/dls4e-$(VERSION).tar.gz
REMOTE_RELEASE_PACKAGE:=releases/dls4e/dls4e-$(VERSION).tar.gz

DOCS:=$(CURDIR)/../docs/release

PLATFORM_DEPLOYER:=$(CURDIR)/deployers/platform
DLS4E_DEPLOYER:=$(CURDIR)/deployers/dls4e
RELEASE_DEPLOYER:=$(CURDIR)/deployers/release

# Global exports
export VERSION_MAJOR := $(DEFAULT_VERSION_MAJOR)
export VERSION_MINOR := $(DEFAULT_VERSION_MINOR)
export VERSION_NO := $(DEFAULT_VERSION_NO)
export VERSION_ID := $(DEFAULT_VERSION_ID)
export GLOBAL_WORKSPACE := $(GLOBAL_WORKSPACE)
export GLOBAL_VIRTUALENV_DIR := $(GLOBAL_VIRTUALENV_DIR)

$(DOCKER_PACKAGE): export ENV_OUTPUT := $(DOCKER_PACKAGE)
$(DOCKER_PACKAGE): $(BUILD_DIR)
	@$(CONTAINER_MAKE)

$(PLATFORM_PACKAGE): $(DOCKER_PACKAGE)
$(PLATFORM_PACKAGE): export INCLUDED_FILES := $(DOCKER_PACKAGE)
$(PLATFORM_PACKAGE): export ENV_OUTPUT := $(PLATFORM_PACKAGE)
$(PLATFORM_PACKAGE): $(BUILD_DIR)
	@$(RPMS_MAKE)
	@rm $(DOCKER_PACKAGE)

$(PLATFORM_CHART): export ENV_OUTPUT := $(PLATFORM_CHART)
$(PLATFORM_CHART): $(BUILD_DIR)
	@$(CHART_MAKE)

$(DLS4E_CHART): export ENV_OUTPUT := $(DLS4E_CHART)
$(DLS4E_CHART): $(BUILD_DIR)
	@$(CHART_MAKE)

$(DLS4E_PACKAGE): export ENV_OUTPUT := $(DLS4E_PACKAGE)
$(DLS4E_PACKAGE): $(BUILD_DIR)
	@$(CONTAINER_MAKE)

$(COMPILER_PACKAGE): export ENV_OUTPUT := $(COMPILER_PACKAGE)
$(COMPILER_PACKAGE): $(BUILD_DIR)
	@$(CONTAINER_MAKE)

$(BIN_RELEASE_PACKAGE): export ENV_BUILD_CONFIG := $(COMPILER_CONFIG)
$(BIN_RELEASE_PACKAGE): export NAME := compiler
$(BIN_RELEASE_PACKAGE): $(COMPILER_PACKAGE)
$(BIN_RELEASE_PACKAGE): export ENV_PLATFORM_PACKAGE := $(COMPILER_PACKAGE)
$(BIN_RELEASE_PACKAGE): export ENV_OUTPUT := $(BIN_RELEASE_PACKAGE)
$(BIN_RELEASE_PACKAGE): $(BUILD_DIR)
	@$(FINALIZERS_BIN_MAKE)
	@rm $(COMPILER_PACKAGE)

$(DOCS_RELEASE_PACKAGE): export ENV_BUILD_CONFIG := $(COMPILER_CONFIG)
$(DOCS_RELEASE_PACKAGE): export NAME := docs
$(DOCS_RELEASE_PACKAGE): export ENV_DOCS_PACKAGE := $(DOCS)
$(DOCS_RELEASE_PACKAGE): export ENV_OUTPUT := $(DOCS_RELEASE_PACKAGE)
$(DOCS_RELEASE_PACKAGE): $(BUILD_DIR)
	@$(FINALIZERS_DOCS_MAKE)

ifeq ($(RELEASE_DISABLE_BUILD),)
$(PLATFORM_RELEASE_PACKAGE): export ENV_BUILD_CONFIG := $(PLATFORM_CONFIG)
$(PLATFORM_RELEASE_PACKAGE): export NAME := platform
$(PLATFORM_RELEASE_PACKAGE): $(PLATFORM_PACKAGE) $(PLATFORM_CHART)
$(PLATFORM_RELEASE_PACKAGE): export ENV_CHART := $(PLATFORM_CHART)
$(PLATFORM_RELEASE_PACKAGE): export ENV_PLATFORM_PACKAGE := $(PLATFORM_PACKAGE)
$(PLATFORM_RELEASE_PACKAGE): export ENV_OUTPUT := $(PLATFORM_RELEASE_PACKAGE)
$(PLATFORM_RELEASE_PACKAGE): export ENV_DEPLOYER := $(PLATFORM_DEPLOYER)
$(PLATFORM_RELEASE_PACKAGE): $(BUILD_DIR)
	@$(FINALIZERS_PLATFORM_MAKE)
	@rm $(PLATFORM_PACKAGE)
else
$(PLATFORM_RELEASE_PACKAGE): $(BUILD_DIR)
	@tar -zvcf $(PLATFORM_RELEASE_PACKAGE) --files-from /dev/null
endif

$(DLS4E_RELEASE_PACKAGE): export ENV_BUILD_CONFIG := $(DLS4E_CONFIG)
$(DLS4E_RELEASE_PACKAGE): export NAME := dls4e
$(DLS4E_RELEASE_PACKAGE): $(DLS4E_PACKAGE) $(DLS4E_CHART)
$(DLS4E_RELEASE_PACKAGE): export ENV_CHART := $(DLS4E_CHART)
$(DLS4E_RELEASE_PACKAGE): export ENV_PLATFORM_PACKAGE := $(DLS4E_PACKAGE)
$(DLS4E_RELEASE_PACKAGE): export ENV_OUTPUT := $(DLS4E_RELEASE_PACKAGE)
$(DLS4E_RELEASE_PACKAGE): export ENV_DEPLOYER := $(DLS4E_DEPLOYER)
$(DLS4E_RELEASE_PACKAGE): $(BUILD_DIR)
	@$(FINALIZERS_DLS4E_MAKE)
	@rm $(DLS4E_PACKAGE)

$(RELEASE_PACKAGE): $(DLS4E_RELEASE_PACKAGE) $(PLATFORM_RELEASE_PACKAGE) $(BIN_RELEASE_PACKAGE) $(DOCS_RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_DOCS_PACKAGE := $(DOCS_RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_PLATFORM_PACKAGE := $(PLATFORM_RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_DLS4E_PACKAGE := $(DLS4E_RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_BIN_PACKAGE := $(BIN_RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_OUTPUT := $(RELEASE_PACKAGE)
$(RELEASE_PACKAGE): export ENV_DEPLOYER := $(RELEASE_DEPLOYER)
$(RELEASE_PACKAGE): $(BUILD_DIR)
	@$(FINALIZERS_RELEASE_MAKE)
	@rm $(DLS4E_RELEASE_PACKAGE) $(PLATFORM_RELEASE_PACKAGE) $(BIN_RELEASE_PACKAGE)

.PHONY: platform dls4e all push

compiler: $(BIN_RELEASE_PACKAGE)

platform: $(PLATFORM_RELEASE_PACKAGE)

dls4e: $(DLS4E_RELEASE_PACKAGE)

all: $(RELEASE_PACKAGE)

release: ENV_S3_URL ENV_ACCESS_KEY ENV_SECRET_KEY
release: export ENV_S3_URL := $(ENV_S3_URL)
release: export ENV_ACCESS_KEY := $(ENV_ACCESS_KEY)
release: export ENV_SECRET_KEY := $(ENV_SECRET_KEY)
release: $(RELEASE_PACKAGE)
release: export ENV_SRC := $(RELEASE_PACKAGE)
release: export ENV_DEST := $(REMOTE_RELEASE_PACKAGE)
release:
	@$(PUSH_MAKE)

push: ENV_S3_URL ENV_ACCESS_KEY ENV_SECRET_KEY ENV_SRC ENV_DEST
push: export ENV_S3_URL := $(ENV_S3_URL)
push: export ENV_ACCESS_KEY := $(ENV_ACCESS_KEY)
push: export ENV_SECRET_KEY := $(ENV_SECRET_KEY)
push: export ENV_SRC := $(ENV_SRC)
push: export ENV_DEST := $(ENV_DEST)

push:
	@$(PUSH_MAKE)
