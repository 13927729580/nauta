---

- name: Ensure directory exists
  file:
    path: "{{ image.directory }}"

- name: Download all required files
  get_url:
    url: "{{ item.src }}"
    dest: "{{ image.directory }}/{{ item.dest }}"
    checksum: "sha256:{{ item.checksum }}"
  with_items: "{{ image.fetch_files | default([]) }}"

- name: List files in directory
  find:
    path: "{{ image.directory }}"
    get_checksum: True
    recurse: True
  register: files

- set_fact:
    dir_sha: "{{ files | json_query('files[].checksum') | sort | join(' ' ) | hash('sha1') }}"

- name: Add image definition
  set_fact:
    docker_images_local_tags: "{{ docker_images_local_tags | combine({ name: dir_sha }) }}"
